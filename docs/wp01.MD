# Use Azure file shares in a multi region environment

## Objective:

Setup two Azure region (for example EU, US) connected to each other using VNET peering. The EU configuration will host a file share providing upload and download capabilities, serving single and parallel downloads from multiple clients. 

Also it is optimize for best performance and provide proof with measurements. Additionally, create a secure and authenticated/authorized connection concept from a US office to the web service hosted in the EU. IaC is managed by Terraform.

## Overview

To establish secure connection between a US-based office and a web service deployed in the EU region on Azure. The design focuses on authentication, authorization, and ensuring data encryption in transit and at rest. The solution utilizes industry-standard protocols and Azure services to ensure security and compliance.

## Solution Architecture

### 1. **Design a Secure and Authenticated/Authorized Connection from US Office to EU Web Service**

We establish a secure connection from the US office to the EU-based Azure web service by implementing the following:

- **Azure VPN Gateway or Azure ExpressRoute**:  
  A secure site-to-site Virtual Private Network (VPN) can be set up using Azure VPN Gateway or Azure ExpressRoute for more private, dedicated connections. This allows the US office to securely connect to the EU Azure resources over the internet (VPN) or using a private fiber-optic connection (ExpressRoute).

  - **Azure VPN Gateway**: 
    - Uses IPsec/IKE protocols to secure the connection.
    - Provides authentication at the gateway level and encryption in transit.

  - **Azure ExpressRoute**: 
    - Provides a private connection, bypassing the public internet.
    - More secure, reliable, and low-latency than VPN.
  
  Both methods support encrypted and authenticated communication.

### 2. **Authentication and Authorization Mechanisms**

To secure access to the web service in the EU, the following authentication and authorization mechanisms are implemented:

- **Azure Active Directory (Azure AD) for Authentication**:
  - Azure AD enables identity management, providing **Single Sign-On (SSO)** and multi-factor authentication (MFA) capabilities.
  - **OAuth 2.0 / OpenID Connect** are leveraged for user authentication to the web service.
  - Applications or users must authenticate against Azure AD to access the web service.

- **Managed Identities for Azure Resources**:
  - Secure access between Azure services (e.g., web service and backend database) is managed using **Azure Managed Identities**, avoiding the need to store credentials in application code.

- **Role-Based Access Control (RBAC) for Authorization**:
  - Using **Azure RBAC**, only authorized users, applications, or services can access the web service.
  - Fine-grained permissions are applied to limit access based on roles (e.g., Reader, Contributor, Owner).
  - RBAC ensures that users or systems have the minimal permissions necessary to perform their tasks.

### 3. **Data Encryption**

To protect sensitive data, encryption is applied both **in transit** and **at rest**:

- **Encryption in Transit**:
  - The connection between the US office and the EU web service is encrypted using **SSL/TLS**.
  - Azure VPN Gateway ensures the VPN traffic is encrypted using **IPsec/IKE**.
  - **Azure Front Door** or **Azure Application Gateway** can be configured to terminate SSL/TLS at the edge for HTTPS traffic.

- **Encryption at Rest**:
  - Data stored in Azure services (such as databases or storage accounts) is encrypted at rest using **Azure Storage Service Encryption (SSE)** with **AES-256**.
  - Azure Key Vault is used to manage encryption keys, further securing data at rest.
  

## 4. **Network Design**

Here is a simplified high-level network design for the secure connection:

1. **US Office**: 
   - Local Network with VPN or ExpressRoute connection to Azure.
   - Users and systems authenticate via Azure AD before accessing the EU web service.
   
2. **Azure VPN Gateway/ExpressRoute**:
   - Acts as the secure bridge between US office and Azure services in the EU.
   
3. **Azure Web Service (EU Region)**:
   - Hosted in a Virtual Network (VNet) in the EU region, with subnets for web services and backend resources.
   - Azure AD authentication ensures secure access.
   
4. **Azure Key Vault**:
   - Used for managing and protecting encryption keys and secrets for the web service.
---

## Scalability

Azure file share size is limited to 100 tebibytes (TiB). There's no minimum file share size and no limit on the number of Azure file shares.
Maximum size of a file in a file share is 1 TiB, and there's no limit on the number of files in a file share.
IOPS and throughput limits are per Azure storage account and are shared between Azure file shares in the same storage account.

## Security

Use AD DS authentication over SMB for accessing Azure file shares. This setup provides the same seamless single sign-on (SSO) experience when accessing Azure file shares as accessing on-premises file shares. Your client needs to be domain joined to AD DS, because the authentication is still done by the AD DS domain controller. Also, you need to assign both share level and file/directory level permissions to get access to the data. Share level permission assignment goes through Azure RBAC model. File/directory level permission is managed as Windows ACLs.

 
All data that's stored on Azure file share is encrypted at rest using Azure storage service encryption (SSE). By default, data stored in Azure Files is encrypted with Microsoft-managed keys. With Microsoft-managed keys, Microsoft maintains the keys to encrypt/decrypt the data and manages rotating them regularly. You can also choose to manage your own keys, which gives you control over the rotation process.

All Azure storage accounts have encryption in transit enabled by default. This setup means that all communication with Azure file shares is encrypted. Clients that don't support encryption can't connect to Azure file shares. 

By default, clients can connect to Azure file share from anywhere. To limit the networks from which clients can connect to Azure file shares, configure the Firewall, virtual networks, and private endpoint connections. 

Below is a structured solution for an **Azure Secure Connection Concept** that would be documented in a `README.md` file format. This approach covers the secure connection, authentication and authorization mechanisms, data encryption, and provides a link for network design diagrams.

---

## Key Considerations

- **Compliance**: Ensure that the solution complies with relevant security standards such as **GDPR** (since the web service is hosted in the EU).
- **Scalability**: Both Azure VPN Gateway and ExpressRoute are scalable solutions that can accommodate growth as more users or services connect to the web service.
- **High Availability**: Leverage **Azure Traffic Manager** for geo-redundancy, ensuring high availability between the US office and EU services.

---



