# Use Azure file shares in a multi region environment

## Objective:

Setup two Azure region (for example EU, US) connected to each other using VNET peering. The EU configuration will host a file share providing upload and download capabilities, serving single and parallel downloads from multiple clients. 

Also it is optimize for best performance and provide proof with measurements. Additionally, create a secure and authenticated/authorized connection concept from a US office to the web service hosted in the EU. IaC is managed by Terraform.

## Overview

This document outlines the design of a secure, authenticated, and authorized connection between resources in the US-West office and the EU office using Azure Virtual Network (VNet) peering. This solution ensures encrypted data transmission between offices, as well as secure authorization and authentication mechanisms.

This design offers a secure and authenticated solution to connect resources between the US office and the EU web service using Azure VNet peering. It incorporates robust security practices, such as identity management, encrypted communication, and comprehensive monitoring. These measures ensure that data is protected in transit and at rest, and that only authorized users can access services.

### **Key Components:**
- US-West Office Resource Group: `uswest1`
- EU Central Office Resource Group: `eucentral`
- Virtual Network Peering: Secures private network connectivity between two regions
- Authentication & Authorization: Ensures only authorized users and systems access the resources
- Encryption: Data is encrypted both in transit and at rest

## Architecture:

This architecture shows how to include Azure file shares in your hybrid environment. Azure file shares are used as serverless file shares. By integrating them with Active Directory Domain Services (AD DS), you can control and limit access to AD DS users. Azure file shares then can replace traditional file servers.

---

## **1. Network Design Overview**

### **Network Architecture:**
The following components will be deployed in two regions:
1. **US-West Office** (Resource Group: `uswest1`)
   - Virtual Network (VNet): `vnet-uswest`
   - Subnets: Defined to handle office resources
   - Network Security Groups (NSGs): Control traffic flow

2. **EU Central Office** (Resource Group: `eucentral`)
   - Virtual Network (VNet): `vnet-eucentral`
   - Subnets: Defined for web services and secure communication
   - Network Security Groups (NSGs): Control access to the web services

### **VNet Peering Design:**
- **Objective**: Securely connect the `vnet-uswest` and `vnet-eucentral` networks using **VNet Peering** to create a private, secure communication path between both offices without exposing resources to the public internet.
- **Solution**: Traffic between these VNets will stay within the Azure backbone, reducing latency and enhancing security.

![File Share Solution Design](./images/WP01SolutionDesign.jpeg)

#### **Network Peering Diagram**
As the above diagram depicts:
- The two virtual networks (`vnet-uswest` and `vnet-eucentral`) connected via **VNet Peering**.
- Office resources in the US region accessing the EU region's File Storage.
- Subnet segmentation and routing between regions.
- Secure communication through firewalls and Network Security Groups (NSGs).

---
## **2. VNet Peering Setup**
### **Step 1: Create Virtual Networks in US and EU Regions**
- US-West VNet
- EU-Central VNet

### **Step 2: Enable VNet Peering**
- From US-West to EU-Central
- From EU-Central to US-West

### **Step 3: Configure Network Security Groups (NSGs)**
Apply appropriate NSG rules to allow traffic between the two VNets for specific ports/services (e.g., HTTPS).

---

## **3. Authentication and Authorization Mechanisms**
### **Authentication Mechanisms:**
1. **Azure Active Directory (AAD)**: Use AAD for managing identities and implementing access control for users and applications.
   - **Service Authentication**
   - **User Authentication**


### **Authorization Mechanisms:**
1. **Role-Based Access Control (RBAC)**: Control which users or applications can access resources by assigning Azure roles (e.g., Reader, Contributor) in both resource groups (`uswest1` and `eucentral`).
2. **NSG Rules**: NSGs ensure that only traffic from trusted subnets or users is allowed to pass through the network.

---

## **4. Data Encryption**

### **Encryption in Transit:**
All data flowing between the US and EU VNets will be encrypted using **TLS/SSL** protocols. The connection through VNet Peering remains private over the Azure backbone and does not traverse the public internet.


### **Encryption at Rest:**
- All data stored in Azure (both in the US and EU) will use Azure-managed encryption at rest, leveraging **Azure Storage Service Encryption (SSE)** and **Azure Disk Encryption** for VMs.
- For databases, **Transparent Data Encryption (TDE)** will be applied.

---

## **5. Security Considerations**

### **1. Private Network Communication:**
- VNet Peering ensures that all communication between the two offices remains within Azureâ€™s private network, reducing exposure to the public internet.

### **2. Identity and Access Management:**
- We could use Azure Active Directory (AAD) to manage access to resources.
- Enforce multi-factor authentication (MFA) for additional security when users from the US access resources in the EU.

### **3. Network Security Groups (NSGs):**
- NSGs control inbound and outbound traffic. Ensure rules only permit necessary traffic between the US and EU subnets, and block any other connections by default.

---

## Scalability

Azure file share size is limited to 100 tebibytes (TiB). There's no minimum file share size and no limit on the number of Azure file shares.
Maximum size of a file in a file share is 1 TiB, and there's no limit on the number of files in a file share.
IOPS and throughput limits are per Azure storage account and are shared between Azure file shares in the same storage account.

## Security

Use AD DS authentication over SMB for accessing Azure file shares. This setup provides the same seamless single sign-on (SSO) experience when accessing Azure file shares as accessing on-premises file shares. Your client needs to be domain joined to AD DS, because the authentication is still done by the AD DS domain controller. Also, you need to assign both share level and file/directory level permissions to get access to the data. Share level permission assignment goes through Azure RBAC model. File/directory level permission is managed as Windows ACLs.

 
All data that's stored on Azure file share is encrypted at rest using Azure storage service encryption (SSE). By default, data stored in Azure Files is encrypted with Microsoft-managed keys. With Microsoft-managed keys, Microsoft maintains the keys to encrypt/decrypt the data and manages rotating them regularly. You can also choose to manage your own keys, which gives you control over the rotation process.

All Azure storage accounts have encryption in transit enabled by default. This setup means that all communication with Azure file shares is encrypted. Clients that don't support encryption can't connect to Azure file shares. 

By default, clients can connect to Azure file share from anywhere. To limit the networks from which clients can connect to Azure file shares, configure the Firewall, virtual networks, and private endpoint connections. 

Below is a structured solution for an **Azure Secure Connection Concept** that would be documented in a `README.md` file format. This approach covers the secure connection, authentication and authorization mechanisms, data encryption, and provides a link for network design diagrams.

---

## Key Considerations

- **Compliance**: Ensure that the solution complies with relevant security standards such as **GDPR** (since the web service is hosted in the EU).
- **Scalability**: Both Azure VPN Gateway and ExpressRoute are scalable solutions that can accommodate growth as more users or services connect to the web service.
- **High Availability**: Leverage **Azure Traffic Manager** for geo-redundancy, ensuring high availability between the US office and EU services.

---



